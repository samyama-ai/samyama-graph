name: Publish Crate to Crates.io

on:
  release:
    types: [created]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  publish:
    name: Publish samyama-optimization
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        shell: bash
        run: |
          publish_crate() {
              CRATE=$1
              echo "--------------------------------------------------"
              echo "üöÄ Processing $CRATE..."
              
              # Dry run first to check compilation/packaging
              # cargo publish --dry-run -p $CRATE
              
              # Attempt real publish
              OUTPUT=$(cargo publish -p $CRATE 2>&1)
              EXIT_CODE=$?
              
              if [ $EXIT_CODE -eq 0 ]; then
                  echo "‚úÖ Success: $CRATE published."
              elif echo "$OUTPUT" | grep -q "already exists"; then
                  echo "‚ö†Ô∏è  Skipping: Version already exists on crates.io."
              elif echo "$OUTPUT" | grep -q "already uploaded"; then
                  echo "‚ö†Ô∏è  Skipping: Version already exists on crates.io."
              else
                  echo "‚ùå Error: Failed to publish $CRATE"
                  echo "$OUTPUT"
                  return $EXIT_CODE
              fi
          }

          # Publish order matters if there are dependencies
          publish_crate samyama-graph-algorithms
          publish_crate samyama-optimization
